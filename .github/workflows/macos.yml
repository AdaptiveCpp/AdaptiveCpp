name: macOS build

on: [push, pull_request]

jobs:
  build_appleclang:
    name: AppleClang [macOS]
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: 'recursive'
    - name: install dependencies
      run: |
        set +e
        brew update
        brew install cmake
        brew install libomp
        brew install boost
        set -e
    - name: build
      run: |
        OMP_ROOT=`brew list libomp | grep libomp.a | sed -E "s/\/lib\/.*//"`
        mkdir build && cd build
        cmake .. \
        -DOpenMP_libomp_LIBRARY=$OMP_ROOT/lib/libomp.a \
        -DOpenMP_C_LIB_NAMES=libomp \
        -DOpenMP_C_FLAGS="-Xclang -fopenmp" \
        -DOpenMP_C_INCLUDE_DIR=$OMP_ROOT/include \
        -DOpenMP_CXX_LIB_NAMES=libomp \
        -DOpenMP_CXX_FLAGS="-Xclang -fopenmp" \
        -DOpenMP_CXX_INCLUDE_DIR=$OMP_ROOT/include \
        -DCMAKE_INSTALL_PREFIX=/Users/runner/work/hipSYCL/hipSYCL/build/install
        make -j 2 install VERBOSE=ON
    - name: build CPU tests
      run: |
        mkdir build/tests-cpu && cd build/tests-cpu
        cmake \
        -HIPSYCL_TARGETS=omp.library-only \
        -DOpenMP_libomp_LIBRARY=$OMP_ROOT/lib/libomp.a \
        -DOpenMP_C_LIB_NAMES=libomp \
        -DOpenMP_C_FLAGS="-Xclang -fopenmp" \
        -DOpenMP_C_INCLUDE_DIR=$OMP_ROOT/include \
        -DOpenMP_CXX_LIB_NAMES=libomp \
        -DOpenMP_CXX_FLAGS="-Xclang -fopenmp" \
        -DOpenMP_CXX_INCLUDE_DIR=$OMP_ROOT/include \
        -DhipSYCL_DIR=/Users/runner/work/hipSYCL/hipSYCL/build/install/lib/cmake/hipSYCL \
        /Users/runner/work/hipSYCL/hipSYCL/tests
        make -j 2 VERBOSE=ON
    - name: run CPU tests
      run: |
        cd /Users/runner/work/hipSYCL/hipSYCL/build/tests-cpu
        LD_LIBRARY_PATH=/Users/runner/work/hipSYCL/hipSYCL/build/install/lib ./sycl_tests
