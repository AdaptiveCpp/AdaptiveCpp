name: Package AdaptiveCpp for Ubuntu
on: [push, pull_request]

jobs:
  packaging-acpp-cpu-backend:
    name: Packaging AdaptiveCpp, clang ${{matrix.clang}}, ${{matrix.os}}
    runs-on: ${{matrix.os}}
    strategy:
      matrix:
        clang: ['17']
        os: [ubuntu-22.04]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: install LLVM
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{matrix.clang}}
          sudo apt install libclang-${{matrix.clang}}-dev clang-tools-${{matrix.clang}} libomp-${{matrix.clang}}-dev llvm-${{matrix.clang}}-dev liblld-${{matrix.clang}}-dev
      - name: install boost
        run: |
          sudo apt install libboost-all-dev
      - name: setup build environment
        run: |
          export CXXFLAGS="$CXXFLAGS"
          if [[ "${{matrix.clang}}" != "11" && "${{matrix.clang}}" -lt "16" ]]; then
            export OMP_CXX_FLAGS="$CXXFLAGS -fexperimental-new-pass-manager"
            export CC=clang-${{matrix.clang}}
            export CXX=clang++-${{matrix.clang}}
          fi
          echo "CC=${CC}" >> $GITHUB_ENV
          echo "CXX=${CXX}" >> $GITHUB_ENV
          echo "OMP_CXX_FLAGS=${OMP_CXX_FLAGS}" >> $GITHUB_ENV
      - name: install cmake
        run: |
          sudo apt install cmake
      - name: install packaging helpers
        run: |
          sudo  apt install build-essential
          sudo  apt install devscripts
          sudo  apt install debhelper
      - name: install CUDA
        run : |
          mkdir -p /opt/AdaptiveCpp/cuda
          wget -q -O cuda.sh http://developer.download.nvidia.com/compute/cuda/11.0.2/local_installers/cuda_11.0.2_450.51.05_linux.run
          sudo sh cuda.sh --override --silent --toolkit --no-man-page --no-drm --no-opengl-libs --installpath=/opt/AdaptiveCpp/cuda || true
          echo "CUDA Version ${{matrix.cuda}}" | sudo tee /opt/AdaptiveCpp/cuda/version.txt
          rm cuda.sh
      - name: package AdaptiveCpp
        run: |
          export DEBEMAIL="sanchi.vaishnavi@stud.uni-heidelberg.de"
          export DEBFULLNAME="Sanchi Vaishnavi"
          echo "DEBEMAIL=${DEBEMAIL}" >> $GITHUB_ENV
          echo "DEBFULLNAME=${DEBFULLNAME}" >> $GITHUB_ENV
          cd ..
          cp -R AdaptiveCpp acpp-23.10.0
          tar -cf acpp_23.10.0.orig.tar.gz acpp-23.10.0/
          cd acpp-23.10.0/
          debuild -us -uc
      - name: Install the package
        run: |
          cd ${GITHUB_WORKSPACE}/../
          sudo dpkg -i acpp_23.10.0-1_amd64.deb
      - name: Release Packages
        uses: actions/upload-artifact@v4
        with:
          path: /home/runner/work/AdaptiveCpp/acpp_23.10.0-1_amd64.deb
      - name: build CPU tests
        run: |
          mkdir ${GITHUB_WORKSPACE}/build/tests-cpu
          cd ${GITHUB_WORKSPACE}/build/tests-cpu
          cmake -DACPP_TARGETS="omp" -DAdaptiveCpp_DIR=usr/lib/cmake/AdaptiveCpp ${GITHUB_WORKSPACE}/tests
          make -j2
      - name: run CPU tests
        run: |
          cd ${GITHUB_WORKSPACE}/build/tests-cpu
          LD_LIBRARY_PATH=${GITHUB_WORKSPACE}/build/install/lib ./sycl_tests
        with:
